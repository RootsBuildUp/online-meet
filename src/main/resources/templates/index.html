<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Multi-User Video Room</title>
    <style>
        video { width: 320px; height: 240px; margin: 8px; background: black; }
        #videos { display: flex; flex-wrap: wrap; }
    </style>
</head>
<body>
<h1>Multi-User Video Room</h1>

<label>Room ID: <input id="roomId" value=""></label>
<label>User ID: <input id="clientId" value=""></label>
<label>User Name: <input id="displayName" value=""></label>
<button onclick="joinRoom()">Join Room</button>

<div id="videos"></div>

<script>
    const videos = document.getElementById('videos');
    let ws;
    let clientId;
    let localStream;
    let localPc;
    const peers = {}; // clientId -> RTCPeerConnection

    async function joinRoom() {
        const roomId = document.getElementById('roomId').value.trim();
        clientId = document.getElementById('clientId').value.trim();
        const displayName = document.getElementById('displayName').value.trim();

        if (!roomId || !clientId || !displayName) {
            alert('Please enter Room ID, User ID, and Display Name');
            return;
        }

        try {
            // Check media devices
            const devices = await navigator.mediaDevices.enumerateDevices();
            const hasVideo = devices.some(d => d.kind === 'videoinput');
            const hasAudio = devices.some(d => d.kind === 'audioinput');

            if (!hasVideo && !hasAudio) {
                alert("No camera or microphone found on this device.");
                return;
            }

            // Get local media
            localStream = await navigator.mediaDevices.getUserMedia({ video: hasVideo, audio: hasAudio });
            addVideo(localStream, clientId, true);

            // Connect WebSocket
            const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
            ws = new WebSocket(wsUrl);
            console.log(ws)

            ws.onopen = () => {
                console.log('WebSocket connected');
                ws.send(JSON.stringify({
                    type: 'join',
                    roomId,
                    clientId,
                    displayName
                }));
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);

                switch(msg.type) {
                    case 'offer':
                        if (msg.from === clientId) break;

                        console.log('Received offer from', msg.from);

                        const pc = createPeerConnection(msg.from);
                        peers[msg.from] = pc;

                        await pc.setRemoteDescription({ type: 'offer', sdp: msg.sdp });
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);

                        ws.send(JSON.stringify({
                            type: 'answer',
                            to: msg.from,
                            from: clientId,
                            sdp: answer.sdp
                        }));
                        break;

                    case 'answer':
                        if (!peers[msg.from]) break;

                        console.log('Received answer from', msg.from);
                        await peers[msg.from].setRemoteDescription({ type: 'answer', sdp: msg.sdp });
                        break;

                    case 'ice':
                        if (!peers[msg.from]) break;

                        console.log('Received ICE from', msg.from);
                        try {
                            await peers[msg.from].addIceCandidate(new RTCIceCandidate(msg.candidate));
                        } catch(e) {
                            console.warn('Error adding ICE candidate:', e);
                        }
                        break;

                    case 'new-publisher':
                        if (msg.clientId === clientId) break;

                        console.log('New publisher joined:', msg.clientId);
                        createOfferForPeer(msg.clientId);
                        break;
                }
            };

            ws.onclose = () => console.log('WebSocket closed');

            // Create local publisher peer
            localPc = new RTCPeerConnection();
            localStream.getTracks().forEach(track => localPc.addTrack(track, localStream));

            localPc.onicecandidate = e => {
                if (e.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice',
                        from: clientId,
                        candidate: e.candidate
                    }));
                }
            };

        } catch(err) {
            console.error('Error accessing media devices:', err);
            alert("Could not access camera/microphone. Please check permissions.");
        }
    }

    // Create a peer connection for remote user
    function createPeerConnection(remoteId) {
        const pc = new RTCPeerConnection();

        pc.ontrack = event => addVideo(event.streams[0], remoteId, false);

        pc.onicecandidate = e => {
            if (e.candidate) {
                ws.send(JSON.stringify({
                    type: 'ice',
                    from: clientId,
                    to: remoteId,
                    candidate: e.candidate
                }));
            }
        };

        return pc;
    }

    // Initiate offer to new peer
    async function createOfferForPeer(remoteId) {
        const pc = createPeerConnection(remoteId);
        peers[remoteId] = pc;

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({
            type: 'offer',
            from: clientId,
            to: remoteId,
            sdp: offer.sdp
        }));
    }

    // Add video element
    function addVideo(stream, id, mute=false) {
        let video = document.getElementById(id);
        if (!video) {
            video = document.createElement('video');
            video.id = id;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = mute;
            videos.appendChild(video);
        }
        video.srcObject = stream;
    }
</script>
</body>
</html>
